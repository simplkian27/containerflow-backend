# ContainerFlow Backend – Repository Overview

This document was auto-generated by scanning the repository. It summarizes the structure, tech stack, key scripts, configuration, and API surface.

## Overview

ContainerFlow is a mobile-first waste container management system with:
- Frontend: React Native (Expo) app in `client/`
- Backend: Node.js + Express API in `server/`
- Data: PostgreSQL via Drizzle ORM with schema in `shared/schema.ts`
- Extras: Flexible task scheduler, automotive factory extension, analytics/audit logging

Supporting docs: `README_SCHEDULER.md`, `README_STATS.md`, `replit.md`, `CONTAINERFLOW_PROPOSAL.md`, `DESIGN_BRIEF.md`.

## Tech Stack

- Runtime: Node.js (recommend >= 20)
- Backend: Express, TypeScript, esbuild bundling
- ORM/DB: Drizzle ORM, PostgreSQL (Supabase-compatible), `drizzle-kit`
- Mobile: Expo SDK 54, React Navigation, React Query, Reanimated
- Validation/types: Zod, drizzle-zod
- Lint/format: eslint-config-expo, eslint-plugin-prettier, Prettier

## Repository Layout

- `server/`
  - `index.ts` – Express app setup, CORS, logging, Expo landing/manifest routing, mounts API routes
  - `routes.ts` – Main API router: auth, users, departments, customers, containers (customer/warehouse), tasks, automotive entities, analytics, scheduler endpoints, health checks
  - `db.ts` – Drizzle + `pg` Pool via `process.env.DATABASE_URL` (SSL for Supabase if detected)
  - `storage.ts` – Data access layer (CRUD + domain helpers) using Drizzle
  - `templates/landing-page.html` – Minimal landing page + Expo deep link/QR
- `shared/`
  - `schema.ts` – Drizzle schema (enums, relations, tables, insert schemas, transition guards, UI labels)
- `client/`
  - `App.tsx`, `components/`, `screens/`, `navigation/`, `lib/query-client.ts` (API base URL, error handling)
- `scripts/`
  - `build.js` – Static Expo build helper: drives Metro, fetches bundles/assets, writes manifests into `static-build/`
- `static-build/` – Generated assets and platform manifests (created by `scripts/build.js`)
- `migrations/` – Drizzle migration metadata/output
- Root configs: `package.json`, `tsconfig.json`, `babel.config.js`, `drizzle.config.ts`, `eslint.config.js`, `render.yaml`

## Environment Variables

Create `.env` from `.env.example` and set values (do not commit secrets). Key variables actually used in code:
- `DATABASE_URL` – PostgreSQL connection string (Supabase-compatible)
- `EXPO_PUBLIC_DOMAIN` – Host:port for the API (e.g. `localhost:5000` or `your.app.repl.co:5000`)
- `PORT` – API port (defaults to `5000`)
- `CORS_ORIGINS` – Optional comma-separated origins; falls back to permissive dev behavior

Notes:
- The Expo static build uses `EXPO_PUBLIC_DOMAIN` to construct deep links and base URLs.
- `render.yaml` references `DB_URL`, but the server uses `DATABASE_URL`.

## Scripts (package.json)

- `server:dev` – Start API in dev: `NODE_ENV=development tsx server/index.ts`
- `server:build` – Bundle server with esbuild to `server_dist/`
- `server:prod` – Run built server: `NODE_ENV=production node server_dist/index.js`
- `start` – Alias to production server (`server:prod`)
- `build` – Alias to `server:build`
- `expo:dev` – Start Expo locally with `EXPO_PUBLIC_DOMAIN`
- `all:dev` – Run Expo dev and server dev together
- `expo:start:static:build` – Start Metro for static bundle export
- `expo:static:build` – Generate static bundles/manifests into `static-build/` (runs `scripts/build.js`)
- `expo:web:build` – Export web build to `dist/web-build`
- `db:push` – Apply schema using `drizzle-kit`
- `lint` / `lint:fix` – ESLint
- `check:types` – TypeScript check
- `format` / `check:format` – Prettier

## Running Locally

1) Prereqs
- Node.js >= 20
- PostgreSQL database (or Supabase) and `DATABASE_URL` set

2) Setup
- `cp .env.example .env` and set `DATABASE_URL`, `EXPO_PUBLIC_DOMAIN`, optional `CORS_ORIGINS`, `PORT`
- `npm install`

3) Dev
- API only: `npm run server:dev`
- Expo + API: `npm run all:dev`

4) Production build
- Build API: `npm run server:build`
- Run API: `npm start`
- Static Expo assets: `npm run expo:static:build` (produces `static-build/` consumed by the server; `/` serves landing, `/manifest` serves platform manifest if `expo-platform` header is present)

## API – Quick Reference

Health/debug
- `HEAD /api/health` – 200 if server up
- `GET /api/health` – JSON including database connectivity
- `GET /api/debug/ping` – Simple ping with env hints

Domain highlights (see `server/routes.ts` for full list)
- Users: list/get/create/update (admin-gated create)
- Departments: list/get/create/update/delete (soft delete)
- Customers and Customer Containers: CRUD and lookups by QR
- Warehouse Containers: CRUD, fill history, operations (e.g., empty/reset)
- Tasks: CRUD, status transitions with validation + automatic timestamps
- Scan Events & Activity Logs: append/read for full audit history
- Automotive Extension: materials/halls/stations/stands/boxes + 7‑step task lifecycle with guarded transitions
- Scheduler: flexible schedules (DAILY/WEEKLY/INTERVAL) with preview/run endpoints; legacy dailyFull support
- Analytics: materials/stations/halls endpoints (see `README_STATS.md`)

Auth and roles
- Minimal header-based auth for now: `x-user-id` on requests, enforced with `requireAuth` and `requireAdmin`
- Passwords are stored hashed (SHA‑256) in the DB via `storage.ts` flow

CORS
- Dynamic allowlist for localhost/Replit and optional `CORS_ORIGINS`

Logging
- Per-request timing/logging for `/api/*` plus truncated response snapshot
- Comprehensive audit events (`taskEvents`) for state changes

## Database

- Configuration: `drizzle.config.ts` uses `DATABASE_URL`
- Schema: see `shared/schema.ts` (enums, tables, relations, insert schemas, transition guards, localized labels)
- Migrations: `npm run db:push` (outputs under `migrations/`)

## Build/Tooling

- Compile server: esbuild ESM bundle to `server_dist/`
- Expo static builder: `scripts/build.js` drives Metro, downloads platform bundles/assets, updates manifests, and writes to `static-build/`
- TS path aliases: `@/*` → `./client/*`, `@shared/*` → `./shared/*` (see `babel.config.js`, `tsconfig.json`)

## Deployment Notes

- Render: `render.yaml` present; ensure environment group provides `DATABASE_URL` (or map `DB_URL` → `DATABASE_URL`)
- Server binds `0.0.0.0:${PORT}` (default 5000)
- Expo landing and manifests are served from the same server

## Troubleshooting

- API responds with HTML instead of JSON in app: verify `EXPO_PUBLIC_DOMAIN` points to your API domain (client `lib/query-client.ts` validates this)
- Database connectivity: `GET /api/health` should report `database: connected`
- CORS issues: set `CORS_ORIGINS` or use allowed localhost patterns

## Notable Files

- `server/index.ts`, `server/routes.ts`, `server/storage.ts`, `server/db.ts`
- `shared/schema.ts`
- `client/lib/query-client.ts`, `client/App.tsx`
- `scripts/build.js`
- `drizzle.config.ts`, `eslint.config.js`, `babel.config.js`, `tsconfig.json`

---

Generated: this file summarizes the repository as of the last scan.
